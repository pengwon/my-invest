<!DOCTYPE html>
<html>

<head>
    <title>Portfolio Profit Curve</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
    <div id="profitCurve" style="width: 100%;height:600px;"></div>
    <script>
        fetch('my-investment/data/portfolio-1_change_records.json')
            .then(response => response.json())
            .then(data => {
                var chartDom = document.getElementById('profitCurve');
                var myChart = echarts.init(chartDom);

                // 基金代码和名称映射
                var fundNames = {
                    "000739": "易方达沪深300ETF联接C",
                    "007029": "易方达中证500ETF联接C",
                    "011609": "易方达上证科创50联接C",
                    "017516": "易方达北证50成份指数C",
                    "014533": "易方达MSCI中国A50互联互通ETF联接C"
                };

                var option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            var date = params[0].axisValue;
                            var funds = data.find(record => record.date === date).fund_detail;
                            var tooltipItems = params.map(param => {
                                var fund = funds.find(fund => fund.fund_code === param.seriesName);
                                if (!fund) {
                                    return `${param.seriesName}: ${parseFloat(param.value).toFixed(2)}`;
                                }
                                var cumulativePL = fund.cumulative_earnings !== undefined ? fund.cumulative_earnings : (parseFloat(param.value) - fund.cost).toFixed(2);
                                var holdingEarnings = fund.earnings !== undefined ? fund.earnings : (parseFloat(param.value) - fund.cost).toFixed(2);
                                var color = cumulativePL >= 0 ? 'red' : 'green';
                                return `${param.seriesName}: ${parseFloat(param.value).toFixed(2)} (Cost: ${fund.cost}, Cumulative P&L: <span style="color: ${color};">${cumulativePL}</span>, Holding Earnings: <span style="color: ${color};">${holdingEarnings}</span>)`;
                            });
                            return `${date}<br/>${tooltipItems.join('<br/>')}`;
                        }
                    },
                    legend: {
                        data: ['Total Value'].concat(data[0].fund_detail.map(fund => `${fund.fund_code} ${fundNames[fund.fund_code]}`))
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    toolbox: {
                        feature: {
                            saveAsImage: {},
                            dataZoom: {},
                            restore: {}
                        }
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.map(record => record.date)
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            name: 'Total Value',
                            type: 'line',
                            data: data.map(record => (record.balance + record.fund_value_total).toFixed(2)),
                            smooth: true
                        },
                        ...data[0].fund_detail.map((fund, index) => ({
                            name: `${fund.fund_code} ${fundNames[fund.fund_code]}`,
                            type: 'line',
                            data: data.map(record => record.fund_detail[index].value.toFixed(2)),
                            smooth: true
                        })),
                        ...data[0].fund_detail.map((fund, index) => ({
                            name: `${fund.fund_code} ${fundNames[fund.fund_code]} 收益率`,
                            type: 'line',
                            data: data.map(record => {
                                var fundDetail = record.fund_detail[index];
                                return ((fundDetail.value - fundDetail.cost) / fundDetail.cost * 100).toFixed(2);
                            }),
                            smooth: true,
                            yAxisIndex: 1
                        }))
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: 'Value'
                        },
                        {
                            type: 'value',
                            name: 'Return (%)',
                            position: 'right',
                            axisLabel: {
                                formatter: '{value} %'
                            }
                        }
                    ]
                };
                myChart.setOption(option);
            });
    </script>
</body>

</html>